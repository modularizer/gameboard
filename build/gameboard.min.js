import"three";var P=localStorage.getItem("tabs"),T=P?JSON.parse(P):[];localStorage.getItem("tabs");var wt=Math.floor(Math.random()*1e9),L=Math.max(...T.map(o=>1*o.split("_")[0]),0)+1,rt=L+"_"+wt;T.push(rt);localStorage.setItem("tabs",JSON.stringify(T));window.addEventListener("beforeunload",function(){P=localStorage.getItem("tabs"),T=P?JSON.parse(P):[],T=T.filter(o=>o!==rt),localStorage.setItem("tabs",JSON.stringify(T))});var g=class{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}};var yt=(location.hostname+(location.hash||"")).replace(/[^a-zA-Z0-9]/g,"."),B=class{constructor(t){let{topic:e,name:i,options:s,handlers:n}=t||{};this.handlers=Object.assign(this.handlers,n);let a=localStorage.getItem("name");a&&a.startsWith("anon")&&(a=null),this.name=i||a||"anon"+Math.floor(Math.random()*1e3),localStorage.setItem("name",this.name),this.name+="_"+L,this.tabID=L,this.topic=yt+(e||""),this.send=this.send.bind(this);for(let[r,m]of Object.entries(this.mqttHandlers))this.mqttHandlers[r]=m.bind(this);for(let[r,m]of Object.entries(this.handlers))this.handlers[r]=m.bind(this);this.rollCalls={},this.activeUsers=[],this.activeRTCConnections=[],this.rtcConnections={},this.load=this.load.bind(this),this.load()}load(){if(!window.mqtt){console.warn("MQTT not loaded yet"),setTimeout(this.load.bind(this),100);return}let t=mqtt.connect("wss://public:public@public.cloud.shiftr.io",{clientId:"javascript"});t.on("connect",function(){t.subscribe(this.topic);let e=Date.now();this.rollCalls[e]=[],this.post(e,"rollCall")}.bind(this)),t.on("message",((e,i)=>{if(e===this.topic){let s=JSON.parse(i);if(s.sender===this.name)return;let n=s.type;this.mqttHandlers[n]?this.mqttHandlers[n](s):this.handlers[n]?this.handlers[n](s.data,s.sender):console.warn("Unhandled message type: "+n,s)}}).bind(this)),this.client=t,window.addEventListener("beforeunload",()=>{this.send("left","connection"),this.post("Goodbye","goodbye")})}post(t,e="chat"){let i={sender:this.name,timestamp:Date.now(),type:e,data:t},s=JSON.stringify(i);this.client.publish(this.topic,s)}mqttHandlers={rollCall:t=>{""+t.sender,t.data;let e=t.data,i=!this.rollCalls[e];this.rollCalls[e]||(this.rollCalls[e]=[]),this.activeUsers.includes(t.sender)||(this.activeUsers.push(t.sender),this.handlers.activeUsers&&this.handlers.activeUsers(this.activeUsers)),this.rollCalls[e].includes(t.sender)?console.warn("Already received roll call from "+t.sender,e):(this.rollCalls[e].push(t.sender),this.rtcConnections[t.sender]&&this.rtcConnections[t.sender].connectionState==="connected"?console.warn("Already connected to "+t.sender):(this.rtcConnections[t.sender]&&(console.warn("Already have a connection to "+t.sender+" but it's not connected. Closing and reopening."),this.rtcConnections[t.sender].close()),i&&(this.rtcConnections[t.sender]=new H(this.name,t.sender,this,this.handlers),this.rtcConnections[t.sender].sendOffer())),this.post(e,"rollCall")),this.rollCalls[e]||(this.rollCalls[e]=[])},goodbye:t=>{this.activeUsers=this.activeUsers.filter(e=>e!==t.sender),this.handlers.activeUsers&&this.handlers.activeUsers(this.activeUsers),this.activeRTCConnections=this.activeRTCConnections.filter(e=>e!==t.sender),this.rtcConnections[t.sender]&&(console.warn("Closing connection to "+t.sender+" because they left."),this.rtcConnections[t.sender].close(),delete this.rtcConnections[t.sender])},RTCoffer:t=>{let{offer:e,target:i}=t.data;i==this.name&&(this.rtcConnections[t.sender]&&(console.warn("Already have a connection to "+t.sender+". Closing and reopening."),this.rtcConnections[t.sender].close()),this.rtcConnections[t.sender]=new H(this.name,t.sender,this,this.handlers),this.rtcConnections[t.sender].respondToOffer(e))},RTCanswer:t=>{let{answer:e,target:i}=t.data;if(i!=this.name)return;let s=this.rtcConnections[t.sender];if(!s){console.error("No connection found for "+t.sender);return}s.receiveAnswer(e)},RTCiceCandidate:t=>{let e=this.rtcConnections[t.sender];e||(console.error("No connection found for "+t.sender),this.rtcConnections[t.sender]=new H(this.name,t.sender,this,this.handlers),this.rtcConnections[t.sender].sendOffer()),e.onReceivedIceCandidate(t.data)}};handlers={connection(t,e){this.handlers.RTCconnection&&this.handlers.RTCconnection(t,e),t==="joined"?(this.activeUsers.includes(e)?console.warn("Already received connection from "+e):this.activeUsers.push(e),this.activeRTCConnections.includes(e)||(this.activeRTCConnections.push(e),this.post("joined","connection",e))):t==="left"&&(this.activeUsers=this.activeUsers.filter(i=>i!==e)),this.handlers.activeUsers&&this.handlers.activeUsers(this.activeUsers)}};getRTCConnections(t){return t=t||this.activeUsers,typeof t=="string"&&(t=[t]),t.map(e=>this.rtcConnections[e]).filter(e=>e)}send(t,e,i){let s=this.getRTCConnections(i);for(let n of s)n.send(t,e)}sendDM(t,e){this.send(t,"dm",e)}sendChat(t){this.send(t,"chat")}},H=class{rtcConfiguration={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};constructor(t,e,i,s){this.name=t,this.target=e,this.mqttClient=i,this.handlers=s,this.dataChannels={},this.peerConnection=new RTCPeerConnection(this.rtcConfiguration),this.peerConnection=new RTCPeerConnection(this.rtcConfiguration),this.peerConnection.onicecandidate=this.onicecandidate.bind(this),this.dataChannelDeferredPromises=Object.fromEntries(Object.entries(this.handlers).map(([n,a])=>[n,new g])),this.loadPromise=Promise.all(Object.values(this.dataChannelDeferredPromises).map(n=>n.promise)),this.loaded=!1,this.loadPromise.then((()=>{this.loaded=!0}).bind(this)),this.peerConnection.ondatachannel=(n=>{this.registerDataChannel(n.channel)}).bind(this)}sendOffer(){this.setupDataChannels(),this.peerConnection.createOffer().then(t=>this.peerConnection.setLocalDescription(t)).then(()=>{""+this.target,this.mqttClient.post({offer:this.peerConnection.localDescription,target:this.target},"RTCoffer")})}registerDataChannel(t){t.onmessage=(e=>{this.onmessage(e,t.label)}).bind(this),t.onerror=(e=>{this.dataChannelDeferredPromises[t.label].reject(e),this.ondatachannelerror(e,t.label)}).bind(this),t.onopen=(e=>{this.dataChannelDeferredPromises[t.label].resolve(e)}).bind(this),this.dataChannels[t.label]=t}setupDataChannels(){for(let[t,e]of Object.entries(this.handlers)){let i=this.peerConnection.createDataChannel(t);this.registerDataChannel(i)}}respondToOffer(t){this.peerConnection.setRemoteDescription(new RTCSessionDescription(t)).then(()=>this.peerConnection.createAnswer()).then(e=>this.peerConnection.setLocalDescription(e)).then(e=>{this.mqttClient.post({answer:this.peerConnection.localDescription,target:this.target},"RTCanswer")})}receiveAnswer(t){if(this.peerConnection.signalingState!=="have-local-offer"){console.warn("Wrong state "+this.peerConnection.signalingState);return}this.peerConnection.setRemoteDescription(new RTCSessionDescription(t)),this.loadPromise.then((()=>this.send("joined","connection")).bind(this))}dm(t){this.send(t,"dm")}send(t,e){try{let i=this.handlers[e].raw?t:JSON.stringify(t);this.sendRaw(i,e)}catch{console.error("error sending",e,this.handlers)}}sendRaw(t,e){let i=this.dataChannels[e];if(!i){this.handlers[e]&&console.warn("handler found for type",e,"but no data channel"),console.warn("No data channel for type",e);return}if(i.readyState!=="open"){i.readyState;return}i.send(t)}onmessage(t,e){let i=this.target,s=this.handlers[e],n=s.raw?t.data:JSON.parse(t.data);s?s(n,i):console.warn("No handler for type",e)}onReceivedIceCandidate(t){this.peerConnection.addIceCandidate(new RTCIceCandidate(t))}onicecandidate(t){t.candidate&&this.mqttClient.post(t.candidate,"RTCiceCandidate")}ondatachannel(t){let e=t.channel;this.dataChannels[t.name]=e,e.onmessage=this.onmessage.bind(this)}ondatachannelerror(t,e){}close(){this.peerConnection.close(),this.closed=!0,this.peerConnection=null}};var j=class{constructor(t,e){this.users=e,this.handleIncomingAudioData=this.handleIncomingAudioData.bind(this),this.mute=this.mute.bind(this),this.unmute=this.unmute.bind(this),this.startStreaming=this.startStreaming.bind(this),this.stopStreaming=this.stopStreaming.bind(this),this.send=this.send.bind(this),this.handler=this.handleIncomingAudioData,this.handleIncomingAudioData.raw=!0,this.sourceNode=null,this.processorNode=null,this.streaming=!1,this.muted=!0,this.playing=!1,this.rtcClient=t,this.audioContext=new AudioContext({sampleRate:this.config.sampleRate}),this.audioContext.audioWorklet.addModule("./src/js/utils/audio-processor.js").then(()=>{}),document.body.addEventListener("click",()=>{this.audioContext.state==="suspended"&&this.audioContext.resume()})}set rtcClient(t){this._rtcClient=t,t&&t.handlers&&(t.handlers.audio=this.handler,t.startStreaming=this.startStreaming.bind(this),t.stopStreaming=this.stopStreaming.bind(this),t.mute=this.mute.bind(this),t.unmute=this.unmute.bind(this))}get rtcClient(){return this._rtcClient}send(t){this.rtcClient.send(t,"audio",this.users)}handleIncomingAudioData(t,e){if(this.muted)return;let i=new Float32Array(t),s=this.audioContext.createBuffer(1,i.length,this.audioContext.sampleRate);s.copyToChannel(i,0);let n=this.audioContext.createBufferSource();n.buffer=s,n.connect(this.audioContext.destination),n.start()}config={audio:{sampleSize:16,channelCount:1,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,latency:0,googAutoGainControl:!0,googNoiseSuppression:!0,googHighpassFilter:!0,googTypingNoiseDetection:!0,bitrate:8e3*16},sampleRate:8e3,freq:800,q:1,threshold:-40,knee:10,ratio:5,attack:1e-4,release:.1,delay:1*(localStorage.getItem("delay")||0)};startStreaming(){this.streaming||navigator.mediaDevices.getUserMedia({audio:this.config.audio}).then(t=>{this.sourceNode=this.audioContext.createMediaStreamSource(t);let e=this.audioContext.createBiquadFilter();e.type="bandpass",e.frequency.value=this.config.freq,e.Q.value=this.config.q;let i=this.audioContext.createDynamicsCompressor();i.threshold.value=this.config.threshold,i.knee.value=this.config.knee,i.ratio.value=this.config.ratio,i.attack.value=this.config.attack,i.release.value=this.config.release,this.processorNode=new AudioWorkletNode(this.audioContext,"audio-processor"),this.processorNode.port.onmessage=n=>{let a=new Float32Array(n.data);this.send(a.buffer)};let s=this.audioContext.createDelay(5);s.delayTime.value=this.config.delay,this.sourceNode.connect(s),s.connect(e),e.connect(i),i.connect(this.processorNode),this.startStreamingSubtitles(),this.mediaStream=t,this.streaming=!0}).catch(t=>console.error("Error accessing microphone:",t))}stopStreaming(){this.streaming&&(this.sourceNode.disconnect(),this.mediaStream.getTracks().forEach(t=>t.stop()),this.stopStreamingSubtitles(),this.streaming=!1)}startStreamingSubtitles(){if("webkitSpeechRecognition"in window){let t=new webkitSpeechRecognition;t.continuous=!0,t.interimResults=!0,t.onresult=e=>{let i="";for(let s=e.resultIndex;s<e.results.length;s++)i+=e.results[s][0].transcript;this.rtcClient.send(i,"subtitles",this.users)},t.start()}else console.error("Web Speech API is not supported in this browser.")}stopStreamingSubtitles(){"webkitSpeechRecognition"in window&&new webkitSpeechRecognition().stop()}mute(){this.muted=!0}unmute(){this.muted=!1}};var S=class{constructor(t,e){this.keydownListeners=t,this.keyupListeners=e,this.getKey=this.getKey.bind(this),this.keydown=this.keydown.bind(this),this.keyup=this.keyup.bind(this),this.addTo=this.addTo.bind(this),this.key=null}addTo(t){t.addEventListener("keydown",this.keydown),t.addEventListener("keyup",this.keyup)}getKey(t){let e=t.key;return t.shiftKey&&e!="Shift"&&(e="Shift+"+e),t.altKey&&e!="Alt"&&(e="Alt+"+e),t.ctrlKey&&e!="Control"&&(e="Ctrl+"+e),t.metaKey&&e!="Meta"&&(e="Meta+"+e),t.fnKey&&e!="Fn"&&(e="Fn+"+e),e}keydown(t){let e=this.getKey(t);this.key=e,this.keydownListeners[e]?this.keydownListeners[e].bind(this)(t):this.keydownListeners.default&&this.keydownListeners.default.bind(this)(t,e)}keyup(t){this.key=null;let e=this.getKey(t);this.keyupListeners[e]?this.keyupListeners[e].bind(this)(t):this.keyupListeners.default&&this.keyupListeners.default.bind(this)(t,e)}};import*as d from"three";import{OrbitControls as Ct}from"three/addons/controls/OrbitControls.js";var N=class{constructor(t){return this.item=t,this.initialPosition={x:t.originCube.position.x,y:t.originCube.position.y,z:t.originCube.position.z},this.item.clickRelativePosition=null,this.item.movestate={animation:{started:!1,rotation:{enabled:!1,cycles:null,x:0,y:0,z:0},translation:{enabled:!1,cycles:null,x:0,y:0,z:0},lastMoveTime:null,lastRotationTime:null,lastTranslationTime:null}},this.item.reset=this.reset.bind(this),this.item.jumpTo=this.jumpTo.bind(this),this.item.moveTo=this.moveTo.bind(this),this.item.move=this.move.bind(this),this.item.setRotation=this.setRotation.bind(this),this.item.spinTo=this.spinTo.bind(this),this.item.spin=this.spin.bind(this),this.item.startRotation=this.startRotation.bind(this),this.item.stopRotation=this.stopRotation.bind(this),this.item.startTranslation=this.startTranslation.bind(this),this.item.stopTranslation=this.stopTranslation.bind(this),this.item.moveFrame=this.moveFrame.bind(this),this.item.rotationFrame=this.rotationFrame.bind(this),this.item.translationFrame=this.translationFrame.bind(this),this.item.flip=this.flip.bind(this),this.item}reset(){this.item.originCube.position.x=this.initialPosition.x,this.item.originCube.position.y=this.initialPosition.y,this.item.originCube.position.z=this.initialPosition.z,this.item.movestate={animation:{rotation:{enabled:!1,x:0,y:0,z:0},translation:{enabled:!1,x:0,y:0,z:0}}}}flip(){this.item.rotation.x+=Math.PI}jumpTo(t,e,i){this.item.originCube.position.x=t,this.item.originCube.position.y=Math.max(e,0),this.item.originCube.position.z=i}moveTo(t,e,i,s,n=.01){let a=t-this.item.originCube.position.x,r=e-Math.max(this.item.originCube.position.y,0),m=i-this.item.originCube.position.z;this.move(a,r,m,s,n)}move(t,e,i,s,n=.01){e=Math.max(e,-this.item.originCube.position.y);let a=Math.sqrt(t*t+e*e+i*i);s&&(n=a/(s*60));let m=n*t/a,l=n*e/a,h=n*i/a;this.item.movestate.animation.translation={enabled:!0,cycles:Math.floor(a/n),x:m,y:l,z:h}}spinTo(t,e,i,s,n=.02){let a=t-this.item.rotation.x,r=e-this.item.rotation.y,m=i-this.item.rotation.z;this.spin(a,r,m,s,n)}spin(t,e,i,s,n=.02){s&&(n=t/(s*60));let a=Math.sqrt(t*t+e*e+i*i),r=n*t/a,m=n*e/a,l=n*i/a;this.item.movestate.animation.rotation={enabled:!0,cycles:Math.floor(a/n),x:r,y:m,z:l}}setRotation(t,e,i){this.item.pivot.rotation.x=t,this.item.pivot.rotation.y=e,this.item.pivot.rotation.z=i}translate(t,e,i){this.item.originCube.position.x+=t,this.item.originCube.position.y=Math.max(0,this.item.originCube.position.y+e),this.item.originCube.position.z+=i}rotate(t,e,i){this.item.pivot.rotation.x+=t,this.item.pivot.rotation.y+=e,this.item.pivot.rotation.z+=i}startRotation(t=.02,e=.01,i=0,s=null){this.item.movestate.animation.rotation={enabled:!0,cycles:s,x:t,y:e,z:i}}stopRotation(){this.item.movestate.animation.rotation.enabled=!1}startTranslation(t=.02,e=.01,i=0,s=null){this.item.movestate.animation.translation={enabled:!0,x:t,y:e,z:i}}stopTranslation(){this.item.movestate.animation.translation.enabled=!1}moveFrame(t){this.item.movestate.animation.lastMoveTime=t,this.item.movestate.animation.rotation.enabled&&this.rotationFrame(t),this.item.movestate.animation.translation.enabled&&this.translationFrame(t)}rotationFrame(t){this.item.movestate.animation.lastRotationTime=t;let e=this.item.movestate.animation.rotation;this.rotate(e.x,e.y,e.z),e.cycles===0?this.stopRotation():e.cycles!=null&&e.cycles--}translationFrame(t){this.item.movestate.animation.lastTranslationTime=t;let e=this.item.movestate.animation.translation;this.translate(e.x,e.y,e.z),e.cycles===0?this.stopTranslation():e.cycles!=null&&e.cycles--}onRightClickDown(t){}onRightClickMove(t){}onRightClickUp(t){}};var U=class{constructor(t){t.onMouseDown=t.onMouseDown.bind(t)||function(){},t.onMouseMove=t.onMouseMove.bind(t)||function(){},t.onMouseUp=t.onMouseUp.bind(t)||function(){},this.parent=t,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onTouchStart=this.onTouchStart.bind(this),this.onTouchMove=this.onTouchMove.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this)}setSimulatedMouseButton(t){this.state.simulatedMouseButton=t}addTo(t){t.addEventListener("mousedown",this.onMouseDown.bind(this)),t.addEventListener("mousemove",this.onMouseMove.bind(this)),t.addEventListener("mouseup",this.onMouseUp.bind(this)),t.addEventListener("touchstart",this.onTouchStart.bind(this)),t.addEventListener("touchmove",this.onTouchMove.bind(this)),t.addEventListener("touchend",this.onTouchEnd.bind(this)),t.addEventListener("touchcancel",this.onTouchEnd.bind(this)),t.addEventListener("dblclick",this.onDblClick.bind(this))}state={clickedButton:null,simulatedMouseButton:null};onMouseDown(t,e){t.button==2&&t.preventDefault();let i=this.state.simulatedMouseButton!=null?this.state.simulatedMouseButtom:t.button;this.state.clickedButton=i,this.parent.onMouseDown(t,i,e)}onMouseMove(t,e){this.parent.onMouseMove(t,this.state.clickedButton,e)}onMouseUp(t,e){let i=this.state.clickedButton;this.state.clickedButton=null,this.parent.onMouseUp(t,i,e)}onTouchStart(t){t.touches&&(t.clientX=t.touches[0].clientX,t.clientY=t.touches[0].clientY),this.onMouseDown(t,!0)}onTouchMove(t){t.touches&&(t.clientX=t.touches[0].clientX,t.clientY=t.touches[0].clientY),this.onMouseMove(t,!0)}onTouchEnd(t){this.onMouseUp(t,!0)}onTouchCancel(t){this.onMouseUp(t,!0)}onDblClick(t){t.preventDefault(),this.parent.onDblClick(t)}};function A(o,...t){if(!t.length)return o;let e=t.shift();if(K(o)&&K(e))for(let i in e)K(e[i])?(o[i]||Object.assign(o,{[i]:{}}),A(o[i],e[i])):Object.assign(o,{[i]:e[i]});return A(o,...t)}function K(o){return o&&typeof o=="object"&&!Array.isArray(o)}function vt(o){if(o instanceof d.Vector3)return[o.x,o.y,o.z];if(o instanceof Array)return{x:o[0],y:o[1],z:o[2]};if(typeof o=="object")return o}var O=class extends d.Scene{constructor(t,e){super(),this.loaded=!1,this.loadDeferredPromise=new g,this.loadPromise=this.loadDeferredPromise.promise,this.sceneLoaded=!1,this.display=this.display.bind(this),this.animate=this.animate.bind(this),this.getClickedItem=this.getClickedItem.bind(this),this.setCameraMode=this.setCameraMode.bind(this),this.configure=this.configure.bind(this),this.configCamera=this.configCamera.bind(this),this.configRenderer=this.configRenderer.bind(this),this.configAxesHelper=this.configAxesHelper.bind(this),this.configGridHelper=this.configGridHelper.bind(this),this.configFloor=this.configFloor.bind(this),this.configLights=this.configLights.bind(this),this.sendItemUpdate=this.sendItemUpdate.bind(this),this.receiveItemUpdate=this.receiveItemUpdate.bind(this),this.keyListeners.addTo(window),this.mouseListeners=new U(this),this.mouseListeners.addTo(window),this.raycaster=new d.Raycaster,this.mouse=new d.Vector3(0,0,.5),this.offset=new d.Vector3,this.renderer=new d.WebGLRenderer,this.gridHelper=new d.GridHelper,this.axesHelper=new d.AxesHelper,this.configure(this.config,t,e),super.add(this.gridHelper),super.add(this.axesHelper);let i={camera:this.configCamera,renderer:this.configRenderer,axes:this.configAxesHelper,grid:this.configGridHelper,floor:this.configFloor,lights:this.configLights};this._config=new Proxy(this.config,{get:(s,n)=>{let a=s[n];return typeof a=="object"?new Proxy(s[n],{get:(r,m)=>{let l=r[m];return typeof l=="object"?new Proxy(l,{get:(h,c)=>h[c],set:(h,c,y)=>(h[c]=y,i[n](r),!0)}):l},set:(r,m,l)=>(r[m]=l,i[n](r),!0)}):a},set:(s,n,a)=>(i[n](a),!0)}),window.addEventListener("load",()=>{this.display(document.body),this.sceneLoaded=!0})}keyListeners=new S({ArrowUp:()=>{this.state.selectedItem?this.state.selectedItem.position.z-=this.config.speed:this.camera.position.x+=this.config.speed},ArrowDown:()=>{this.state.selectedItem?this.state.selectedItem.position.z+=this.config.speed:this.camera.position.x-=this.config.speed},ArrowLeft:()=>{this.state.selectedItem?this.state.selectedItem.position.x-=this.config.speed:this.camera.position.y-=this.config.speed},ArrowRight:()=>{this.state.selectedItem?this.state.selectedItem.position.x+=this.config.speed:this.camera.position.y+=this.config.speed},r:()=>{if(this.state.dragging||(this.state.animate=!this.state.animate),this.state.selectedItem){let t=this.state.selectedItem;this.state.selectedItem.pivot.rotateY(Math.PI/2),this.itemRotateEnd(t),t.onRightClickUp&&t.onRightClickUp(event)}},x:()=>{this.reset()},p:()=>{this.state.moveMode="y"},n:()=>{this.state.moveMode="normal"},Control:()=>{this.state.clickMode="right"},Alt:()=>{this.state.clickMode="middle"},default:(t,e)=>{console.warn("Unhandled key:",e),this.state.selectedItem&&this.state.selectedItem.keydown(t,e)}},{Control:()=>{this.state.clickMode="left"},Alt:()=>{this.state.clickMode="left"},default:(t,e)=>{this.state.selectedItem&&this.state.selectedItem.keyup(t,e)},ArrowUp:t=>{this.state.selectedItem&&(this.state.releaseItem=!0,this.onMouseUp(t,0,!1))},ArrowDown:t=>{this.state.selectedItem&&(this.state.releaseItem=!0,this.onMouseUp(t,0,!1))},ArrowLeft:t=>{this.state.selectedItem&&(this.state.releaseItem=!0,this.onMouseUp(t,0,!1))},ArrowRight:t=>{this.state.selectedItem&&(this.state.releaseItem=!0,this.onMouseUp(t,0,!1))}});_config={camera:{mode:"perspective",orthographic:{left:-10,right:10,top:16,bottom:-4},perspective:{fov:50,aspect:window.innerWidth/window.innerHeight,near:.1,far:1e3},minAngle:0,maxAngle:70,position:{x:10,y:10,z:10}},lights:{ambient:{enabled:!0,color:16777215,intensity:.5,type:"ambient"},directional:{enabled:!1,color:16711935,intensity:.9,type:"directional",position:{x:10,y:10,z:10},target:{x:0,y:0,z:0},castShadow:window.shadows},point:{enabled:!0,color:16777215,intensity:1,distance:0,decay:1,type:"point",position:{x:10,y:10,z:10},castShadow:window.shadows}},renderer:{clearColor:16777215,clearAlpha:0,size:{width:window.innerWidth,height:window.innerHeight},shadows:window.shadows},floor:{show:!0,width:100,height:100,y:-.05,color:13421772},speed:.5,grid:{size:10,divisions:10,show:!0},axes:{size:5,show:!0},clickSelect:"jump"};get config(){return this._config}set config(t){this._config=t,this.configure(this._config)}updateConfig(t){let e=A(this.config,t);this.configure(e,e.camera.position,e.camera.lookAt?e.camera.lookAt:{x:0,y:0,z:0})}configure(t,e,i){this.configCamera(this.config.camera,e,i),this.configRenderer(this.config.renderer),this.configAxesHelper(this.config.axes),this.configGridHelper(this.config.grid),this.configFloor(this.config.floor),this.configLights(this.config.lights)}configRenderer(t){this.renderer.setSize(t.size.width,t.size.height),this.renderer.setClearColor(t.clearColor,t.clearAlpha),this.renderer.shadowMap.enabled=t.shadows}configCamera(t,e,i){this.perspectiveCamera=new d.PerspectiveCamera(t.perspective.fov,t.perspective.aspect,t.perspective.near,t.perspective.far);let s=window.innerWidth/window.innerHeight;this.orthographicCamera=new d.OrthographicCamera(t.orthographic.left*s,t.orthographic.right*s,t.orthographic.top,t.orthographic.bottom),e?e=vt(e):this.camera&&(e=this.camera.position.clone()),!i&&this.controls&&this.controls.target&&(i=this.controls.target.clone()),this.camera&&this.camera.parent&&this.remove(this.camera),this.camera=t.mode==="perspective"?this.perspectiveCamera:this.orthographicCamera,e&&this.camera.position.set(e.x,e.y,e.z),this.add(this.camera),this.addOrbitControls(),i&&(this.controls.target.copy(i),this.camera.lookAt(this.controls.target))}addOrbitControls(){this.controls=new Ct(this.camera,this.renderer.domElement),this.controls.minPolarAngle=this.config.camera.minAngle*Math.PI/180,this.controls.maxPolarAngle=this.config.camera.maxAngle*Math.PI/180;for(let[t,e]of Object.entries(this.orbitListeners))this.controls.addEventListener(t,e.bind(this))}orbitListeners={start:()=>{this.state.animate=!1,this.state.dragging=!0},end:()=>{this.state.animate=!0,this.state.dragging=!1}};setCameraMode(t){this.config.camera.mode=t,this.configCamera(this.config.camera)}configAxesHelper(t){this.axesHelper.size=t.size}configGridHelper(t){this.gridHelper.visible=t.show,this.gridHelper.size=t.size,this.gridHelper.divisions=t.divisions}configFloor(t){let e=new d.PlaneGeometry(t.width,t.height,1,1);e.rotateX(-Math.PI/2),e.translate(0,t.y,0);let i=new d.MeshStandardMaterial({color:t.color});this.floor&&this.floor.parent&&this.remove(this.floor),this.floor=new d.Mesh(e,i),this.floor.receiveShadow=!0,this.floor.visible=t.show,super.add(this.floor)}configLights(t){this.lights||(this.lights={});for(let[e,i]of Object.entries(t)){let s=null;i.enabled!=!1&&(i.type=="ambient"?s=new d.AmbientLight(i.color,i.intensity):i.type=="directional"?(s=new d.DirectionalLight(i.color,i.intensity),s.position.set(i.position.x,i.position.y,i.position.z),s.target.position.set(i.target.x,i.target.y,i.target.z),s.castShadow=i.castShadow):i.type=="point"&&(s=new d.PointLight(i.color,i.intensity,i.distance,i.decay),s.position.set(i.position.x,i.position.y,i.position.z),s.castShadow=i.castShadow),this.lights[e]&&this.lights[e].parent&&this.remove(this.lights[e]),this.lights[e]=s,super.add(s))}}state={dragging:!1,animate:!0,items:[],itemsByName:{},selectedItem:null,peerSelections:{},otherSelectedItems:{},selectedFace:null,releaseItem:!0,moveMode:"normal",mouseState:null};checkIfFullyLoaded(){this.loaded||this.state.items.every(t=>t.loaded)&&(this.loaded=!0,this.loadDeferredPromise.resolve(this))}display(t){t.appendChild(this.renderer.domElement),this.animate()}addModel(t,e){if(t.loadPromise)if(t.loaded)this.checkIfFullyLoaded();else{this.loaded&&(this.loaded=!1,this.loadDeferredPromise=new g,this.loadPromise=this.loadDeferredPromise.promise),t.loadPromise.then(this.checkIfFullyLoaded.bind(this)),t.loadPromise.then(()=>{this.addModel.bind(this)(t)}),this.state.itemsByName[t.name]=t;return}if(t.addToScene)return t.addToScene(this);t=new N(t),e&&t.position.set(e.x,e.y,e.z),this.state.items.push(t),this.item=t,this.add(t)}reset(){this.state.items.map(t=>t.reset())}animate(t){requestAnimationFrame(this.animate.bind(this)),this.state.animate&&this.state.items.forEach(e=>{e.moveFrame(t)}),this.controls.enabled&&this.controls.update(),this.renderer.render(this,this.camera)}showRay(t,e,i=65280,s=10,n="rayHelper"){let a=new d.ArrowHelper(t,e,s,i);this.remove(this.getObjectByName(n)),a.name=n,super.add(a)}intersectMovePlane(t){let e,i=this.state.moveMode;i==="normal"?e=this.camera.getWorldDirection(new d.Vector3).negate():i==="x"?e=new d.Vector3(1,0,0):i==="y"?e=new d.Vector3(0,1,0):i==="z"?e=new d.Vector3(0,0,1):i instanceof d.Vector3?e=i:i instanceof Array?e=new d.Vector3(...i):e=new d.Vector3(i.x,i.y,i.z);let s=new d.Plane().setFromNormalAndCoplanarPoint(e,t.position),n=new d.Vector3(this.mouse.x,this.mouse.y,.5).unproject(this.camera);this.raycaster.set(this.camera.position,n.sub(this.camera.position).normalize()),this.raycaster.ray.intersectPlane(s,this.mouse)}getClickedItem(t){this.mouse.x=t.clientX/window.innerWidth*2-1,this.mouse.y=-(t.clientY/window.innerHeight)*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);let e=this.state.items.map(a=>a.model).filter(a=>a),i=this.raycaster.intersectObjects(e,!0);if(this.state.selectedFace){for(let a of i)if(a.face==this.state.selectedFace)return this.state.selectedItem}let s,n;if(i.length){for(s=i[0].object,this.state.selectedFace=i[0].face,n=i[0].point;!e.includes(s);)s=s.parent;s=s.parent.parent,this.state.items.includes(s)||console.error("clicked object not in items",s),s.clickPoint=s.worldToLocal(n)}else s=null;return s}onMouseDown(t,e,i){if(!i&&this.config.clickSelect)if(this.state.selectedItem){this.state.releaseItem=!0,this.state.dragging=!0;return}else this.state.releaseItem=!1;let s=this.getClickedItem(t);s?(this.controls.enabled=!1,this.state.selectedItem=s,this.sendItemUpdate({selected:s.name}),this.state.dragging=!0,this.state.mouseState={original:{x:this.mouse.x,y:this.mouse.y},firstMove:!0,offset:new d.Vector3().copy(s.position).sub(this.mouse),jumpOffset:new d.Vector3},e===2?(this.itemRotateClick(s),s.onRightClickDown&&s.onRightClickDown(t)):e===1?s.onMiddleClickDown&&s.onMiddleClickDown(t):(this.itemDragClick(s),s.onMouseDown&&s.onMouseDown(t))):(this.state.dragging=!1,this.state.selectedItem=null,this.sendItemUpdate({selected:null}),this.state.selectedFace=null,this.controls.enabled=!0)}onMouseMove(t,e,i=!1){if(!this.state.dragging)return;this.getClickedItem(t);let s=this.state.selectedItem;s&&(e===2?(this.itemRotateMove(s),s.onRightClickMove&&s.onRightClickMove(t)):e===1?s.onMiddleClickMove&&s.onMiddleClickMove(t):(t.buttons===1&&(i=!0,this.state.releaseItem=!0),this.itemDragMove(s,i),s.onMouseMove&&s.onMouseMove(t)))}onMouseUp(t,e,i){if(!e){if(!this.state.releaseItem)return;!i&&this.config.clickSelect==="jump"&&this.onMouseMove(t,e,!0)}let s=this.state.selectedItem;s&&(this.state.selectedItem=null,this.sendItemUpdate({selected:null}),this.state.selectedFace=null,this.state.dragging=!1,this.addOrbitControls(),e===2?(this.itemRotateEnd(s),s.onRightClickUp&&s.onRightClickUp(t)):e===1?s.onMiddleClickUp&&s.onMiddleClickUp(t):(this.itemDragEnd(s),s.onMouseUp&&s.onMouseUp(t)),s.snap&&(s.snap(),this.sendItemUpdate({[s.name]:{rotation:s.pivot.rotation.toArray(),position:s.position.toArray()}})))}onDblClick(t){let e=this.getClickedItem(t);e&&(e.pivot.rotateY(Math.PI/2),this.sendItemUpdate({[e.name]:{rotation:e.pivot.rotation.toArray()}}))}itemRotateClick(t){t.pivot.originalQuaternion=t.pivot.quaternion.clone()}itemRotateMove(t){let e=this.mouse.x-this.state.mouseState.original.x,i=-(this.mouse.y-this.state.mouseState.original.y),s=new d.Vector3(i,e,0).normalize(),a=20*Math.sqrt(e*e+i*i),r=new d.Quaternion().setFromAxisAngle(s,a),m=new d.Quaternion().multiplyQuaternions(t.pivot.originalQuaternion,r),l=new d.Euler;l.setFromQuaternion(m),t.snapController&&(l=t.snapController.enforceRotationLocks(l)),this.sendItemUpdate({[t.name]:{rotation:l.toArray()}}),t.pivot.rotation.set(l.x,l.y,l.z)}itemRotateEnd(t){t.snap&&(t.snap(),this.sendItemUpdate({[t.name]:{rotation:t.pivot.rotation.toArray()}})),this.state.startPosition=null}itemDragClick(t){this.intersectMovePlane(t),t.startDragPosition=t.position.clone()}itemDragMove(t,e=!1){this.intersectMovePlane(t);let i=t.position.clone().copy(this.mouse).sub(this.state.mouseState.offset);if(i.y=Math.max(0,i.y),this.state.mouseState.firstMove)this.state.mouseState.jumpOffset=i.clone().sub(t.position),this.state.mouseState.firstMove=!1;else{let s=i.clone().sub(t.position).sub(this.state.mouseState.jumpOffset);if(!e&&this.config.clickSelect==="jump")return;i=t.position.clone().add(s),t.snapController&&(i=t.snapController.enforcePositionLocks(i)),this.sendItemUpdate({[t.name]:{position:i.toArray()}}),t.position.set(i.x,i.y,i.z)}}itemDragEnd(t){if(t.snap){try{t.snap()}catch{t.position.copy(t.startDragPosition)}this.sendItemUpdate({[t.name]:{rotation:t.position.toArray()}})}}attachMQTTRTC(t){this.m=t,this.m.handlers.moves=this.receiveItemUpdate.bind(this),this.syncedFrom=[],this.syncedTo=[],this.m.handlers.sync=this.sync.bind(this),this.syncInterval=setInterval((()=>{this.m.send("request","sync")}).bind(this),1e3),setTimeout((()=>this.m.send("request","sync")).bind(this),100)}sync(t,e){if(t==="request"){if(!this.syncedFrom)return;let i={};for(let[s,n]of Object.entries(this.state.itemsByName))i[s]={position:n.position.toArray(),rotation:n.pivot.rotation.toArray()};this.m.send(i,"sync",e),this.syncedTo.push(e)}else this.receiveItemUpdate(t,e),this.syncedFrom.push(e),this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null)}sendItemUpdate(t){this.m.send(t,"moves")}receiveItemUpdate(t,e){for(let[i,s]of Object.entries(t))if(i==="selected")if(s)this.state.otherSelectedItems[s]||(this.state.otherSelectedItems[s]=[]),this.state.otherSelectedItems[s].push(e),this.state.itemsByName[s].select(16711680),this.state.peerSelections[e]=s;else{s=this.state.peerSelections[e];let n=this.state.otherSelectedItems[s];n&&(this.state.otherSelectedItems[s]=n.filter(a=>a!==e)),this.state.otherSelectedItems[s]&&!this.state.otherSelectedItems[s].length&&this.state.itemsByName[s].unselect()}else{let n=this.state.itemsByName[i];if(!n)continue;s.position&&n.position.set(...s.position),s.rotation&&n.pivot.rotation.set(...s.rotation)}}};import*as u from"three";import{LineGeometry as Et}from"three/addons/lines/LineGeometry.js";import{Line2 as xt}from"three/addons/lines/Line2.js";import{LineMaterial as Mt}from"three/addons/lines/LineMaterial.js";import*as F from"three";var z={},q=class extends F.Vector3{},f=class extends q{distanceTo(t){let e=this.diffAngle(this.x,t.x),i=this.diffAngle(this.y,t.y),s=this.diffAngle(this.z,t.z);return Math.sqrt(e*e+i*i+s*s)}diffAngle(t,e){let i=Math.PI*2,s=3*Math.PI;return t=t%i,e=e%i,Math.abs((t-e+s)%i-Math.PI)}},I=class{constructor(t=[],e=!1,i=!1){this.nodes=t,this.getClosestNode=this.getClosestNode.bind(this),this._getClosestNode=this._getClosestNode.bind(this),typeof e=="string"&&(e={[e]:0}),this.lockedAxes=e||{},i=i||[],typeof i=="string"&&(i={x:i==="x",y:i==="y",z:i==="z"}),Array.isArray(i)&&(i={x:i.includes("x"),y:i.includes("y"),z:i.includes("z")}),this.freeAxes=i}getClosestNode(t){let e=this._getClosestNode(t);return this.enforceLocks(e),this.freeAxes.x&&(e.x=t.x),this.freeAxes.y&&(e.y=t.y),this.freeAxes.z&&(e.z=t.z),e}sortNodesByDistance(t){let e=this.nodes.map(s=>({node:s,distance:s.distanceTo(t)}));return e.sort((s,n)=>s.distance-n.distance),e.map(s=>s.node)}_getClosestNode(t){return this.sortNodesByDistance(t)[0]}enforceLocks(t){return this.lockedAxes.x!==void 0&&(t.x=this.lockedAxes.x),this.lockedAxes.y!==void 0&&(t.y=this.lockedAxes.y),this.lockedAxes.z!==void 0&&(t.z=this.lockedAxes.z),t}},X=class extends I{},_=class extends I{},$=class extends _{constructor(t=!1,e=!1){super([new f(0,0,0),new f(Math.PI/2,0,0),new f(Math.PI,0,0),new f(Math.PI*1.5,0,0),new f(Math.PI*2,0,0),new f(0,Math.PI/2,0),new f(0,Math.PI,0),new f(0,Math.PI*1.5,0),new f(0,Math.PI*2,0),new f(0,0,Math.PI/2),new f(0,0,Math.PI),new f(0,0,Math.PI*1.5),new f(0,0,Math.PI*2)],t,e)}getClosestRotation(t){let e=this._getClosestRotation(t);return this.lockedAxes.x!==void 0&&(e.x=t.x),this.lockedAxes.y!==void 0&&(e.y=t.y),this.lockedAxes.z!==void 0&&(e.z=t.z),this.freeAxes.x&&(e.x=t.x),this.freeAxes.y&&(e.y=t.y),this.freeAxes.z&&(e.z=t.z),e}_getClosestRotation(t){let e=Math.PI/2,i=Math.round(t.x/e)*e,s=Math.round(t.y/e)*e,n=Math.round(t.z/e)*e;return new f(i,s,n)}},Z=class extends _{constructor(t=!1,e=!1){super([new f(0,Math.PI/2,0),new f(0,Math.PI,0),new f(0,Math.PI*1.5,0),new f(0,Math.PI*2,0)],t,e)}getClosestRotation(t){let e=this._getClosestRotation(t);return this.lockedAxes.x!==void 0&&(e.x=t.x),this.lockedAxes.y!==void 0&&(e.y=t.y),this.lockedAxes.z!==void 0&&(e.z=t.z),this.freeAxes.x&&(e.x=t.x),this.freeAxes.y&&(e.y=t.y),this.freeAxes.z&&(e.z=t.z),e}_getClosestRotation(t){let e=Math.PI/2,i=Math.round(t.x/e)*e,s=Math.round(t.y/e)*e,n=Math.round(t.z/e)*e;return new f(i,s,n)}},G=class extends X{constructor(t=1,e=0,i=!1,s=!1){super([],i,s),this.step=typeof t=="number"?new F.Vector3(t,t,t):t,this.offset=typeof e=="number"?new F.Vector3(e,e,e):e}_getClosestNode(t){let e=Math.round((t.x-this.offset.x)/this.step.x)*this.step.x+this.offset.x,i=Math.round((t.y-this.offset.y)/this.step.y)*this.step.y+this.offset.y,s=Math.round((t.z-this.offset.z)/this.step.z)*this.step.z+this.offset.z;return new q(e,i,s)}},tt=class extends G{constructor(t=1,e=0,i="y",s=!1){super(t,e,i,s)}},k=class{constructor(t,e=0,i=1,s=0,n="default",a=!1,r=!1,m=!1,l="grid",h="cube"){if(this.item=t,this.snap=this.snap.bind(this),this.enforceRotationLocks=this.enforceRotationLocks.bind(this),this.enforcePositionLocks=this.enforcePositionLocks.bind(this),this.snapRotation=this.snapRotation.bind(this),this.snapPosition=this.snapPosition.bind(this),this.getClosestRotation=this.getClosestRotation.bind(this),this.getClosestPosition=this.getClosestPosition.bind(this),r){typeof r=="string"&&(r={[r]:!0}),Array.isArray(r)&&(r=r.reduce((c,y)=>(c[y]=!0,c),{}));for(let c in r)r[c]===!0&&(r[c]=t.pivot.rotation[c])}if(n){n==="default"&&(n={y:e}),typeof n=="string"&&(n={[n]:!0}),Array.isArray(n)&&(n=n.reduce((c,y)=>(c[y]=!0,c),{}));for(let c in n)n[c]===!0&&(n[c]=t.pivot.position[c])}l==="grid"&&(l=new tt(i,s,n==="default"?{y:e}:n,a)),l==="lattice"&&(l=new G(i,s,n,a)),h==="cube"&&(h=new $(r,m)),h==="grid"&&(h=new Z(r,m)),h==="up"&&(h=new I([new f(0,0,0)],r,m)),h==="flip"&&(h=new I([new f(0,0,0),new f(0,Math.PI,0)],r,m)),this.rotationNodes=h,this.positionNodes=l}config={enabled:!0,rotation:{enabled:!0,step:Math.PI/2},position:{enabled:!0,step:1}};setNodes(t,e){this.rotationNodes=e,this.positionNodes=t}snap(){this.config.enabled&&(this.config.rotation.enabled&&this.snapRotation(),this.config.position.enabled&&this.snapPosition())}snapPosition(){let t=this.item.position,e=this.getClosestPosition(t);this.item.position.set(e.x,e.y,e.z)}getClosestPosition(t){let e=this.positionNodes.getClosestNode(t);if(this.checkCollision(e))throw new Error("collision");return e}getClosestRotation(t){return this.rotationNodes.getClosestNode(t)}snapRotation(){let t=this.item.pivot.rotation,e=this.getClosestRotation(t);t.set(e.x,e.y,e.z)}enforceRotationLocks(t){return this.rotationNodes.enforceLocks(t)}enforcePositionLocks(t){return this.positionNodes.enforceLocks(t)}checkCollision(t){let e=`${t.x}, ${t.y}, ${t.z}`;return z[e]&&z[e]!==this.item?!0:(z[this.item.lastPositionString]&&delete z[this.item.lastPositionString],z[e]=this.item,this.item.lastPositionString=e,!1)}};var W=class extends u.Group{constructor(t){super(),this.truePivot=new u.Object3D,this.pivot=this.truePivot,this.pivot.position.copy(this.position),this.castShadow=this.config.castShadow,this.receiveShadow=this.config.receiveShadow,this.loadPromise=t,this.loaded=!1,this.wireframe=null,this.originCube=null,this.cube=new u.Mesh(new u.BoxGeometry(1,1,1),new u.MeshBasicMaterial({color:16777215})),this.truePivot.add(this.cube),this.loadPromise.then((e=>{if(typeof e=="object"&&e.config&&e.model)this.config=e.config,this.position.set(e.position.x,e.position.y,e.position.z),this.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),this.truePivot.position.set(e.pivotPosition.x,e.pivotPosition.y,e.pivotPosition.z),this.truePivot.rotation.set(e.pivotRotation.x,e.pivotRotation.y,e.pivotRotation.z),e=new u.ObjectLoader().parse(e.model),this.model=e,this.add(e),this.truePivot.add(this.model),this.add(this.truePivot),this.addOriginCube(),this.addWireframe(),this.truePivot.add(this.wireframe),this.truePivot.add(this.originCube),this.snapController=new k(this),this.setShadow(this.config.castShadow,this.config.receiveShadow);else{this.model=e,e.castShadow=this.config.castShadow,e.receiveShadow=this.config.receiveShadow,this.add(e);let i=this.getBoundingBox(),s=this.getSize(),n=i.getCenter(new u.Vector3);this.truePivot.add(this.model),this.add(this.truePivot),this.truePivot.position.set(s.x/2,0,s.z/2),this.addOriginCube(),this.addWireframe(),this.truePivot.add(this.wireframe),this.truePivot.add(this.originCube),this.snapController=new k(this),this.setShadow(this.config.castShadow,this.config.receiveShadow)}this.loaded=!0,this.remove(this.cube),this.truePivot.remove(this.cube),delete this.cube}).bind(this))}keydown(t,e){this.keydownListeners[e]&&this.keydownListeners[e](t)}keyup(t,e){this.keyupListeners[e]&&this.keyupListeners[e](t)}keydownListeners={ArrowRight:t=>{this.pivot.rotateY(Math.PI/2)},ArrowLeft:t=>{this.pivot.rotateY(-Math.PI/2)}};keyupListeners={};toJSON(){return{isModelCopy:!0,position:this.position,rotation:this.rotation,config:this.config,model:this.model.toJSON(),pivotPosition:this.truePivot.position,pivotRotation:this.truePivot.rotation}}setSnapNodes(t){if(!this.model)return this.loadPromise.then(this.setSnapNodes.bind(this,t));this.snapController.positionNodes=t}setSnapController(...t){if(!this.model)return this.loadPromise.then(this.setSnapController.bind(this,...t));this.snapController=new k(this,...t)}setShadow(t=!0,e=!0){if(this.castShadow=t,this.receiveShadow=e,!this.model)return this.loadPromise.then(this.setShadow.bind(this,t,e));if(this.model){this.model.castShadow=t,this.model.receiveShadow=e;for(let i of this.model.children)i.castShadow=t,i.receiveShadow=e}}snap(){if(!this.model)return this.loadPromise.then(this.snap.bind(this));this.config.snap&&this.snapController&&this.snapController.snap()}config={snap:!0,castShadow:!0,receiveShadow:!0,wireframe:{visible:!1,color:65280,thickness:2},originCube:{visible:!1,color:65535,thickness:.2},selected:{scale:1.05,wireframe:!0,originCube:!0,offset:new u.Vector3(0,.5,0)}};getBoundingBox(){var t=new u.Box3;return this.traverse(function(e){if(e.isMesh){e.geometry.computeBoundingBox();var i=e.geometry.boundingBox.clone();i.applyMatrix4(e.matrixWorld),t.union(i)}}),t.min.add(this.model.position),t.max.add(this.model.position),t}getSize(){let t=new u.Vector3;return this.getBoundingBox().getSize(t),t}getRepresentativeSize(){let t=this.getSize(),e=[t.x,t.y,t.z];return e.sort(),(e[0]+e[1])/2}addOriginCube(){let t=this.getRepresentativeSize(),e=this.config.originCube.thickness,i=new u.BoxGeometry(t*e,t*e,t*e),s=new u.MeshBasicMaterial({color:this.config.originCube.color}),n=new u.Mesh(i,s);n.visible=this.config.originCube.visible,this.originCube=n}addWireframe(){let t=this.getBoundingBox(),e=new u.BoxGeometry(t.max.x-t.min.x,t.max.y-t.min.y,t.max.z-t.min.z);e.translate((t.min.x+t.max.x)/2,(t.min.y+t.max.y)/2,(t.min.z+t.max.z)/2);let i=new u.EdgesGeometry(e),s=new Et;s.setPositions(i.attributes.position.array);let a=this.getRepresentativeSize()*this.config.wireframe.thickness,r=new Mt({color:this.config.wireframe.color,linewidth:a}),m=new xt(s,r);r.resolution.set(window.innerWidth,window.innerHeight),m.visible=this.config.wireframe.visible,this.wireframe=m}setColor(t){if(!this.model)return this.cube.material.color.set(t),this.loadPromise.then(()=>{this.setColor(t)});this.model.traverse(e=>{e instanceof u.Mesh&&(Array.isArray(e.material)?e.material.forEach(i=>{i.color.set(t)}):e.material.color.set(t))})}setPosition(t){if(!this.model)return this.cube.position.set(t.x,t.y,t.z),this.loadPromise.then(()=>{this.setPosition(t)});this.model.position.set(t.x,t.y,t.z)}rotate(t=0,e=0,i=0){this.pivot.rotation.x+=t,this.pivot.rotation.y+=e,this.pivot.rotation.z+=i}onMouseDown(t){let e=this.config.selected.scale;this.scale.set(e,e,e),this.offset||(this.offset=!0,this.model.position.add(this.config.selected.offset),this.wireframe.position.add(this.config.selected.offset),this.originCube.position.add(this.config.selected.offset)),this.wireframe.visible=this.config.selected.wireframe,this.originCube.visible=this.config.selected.originCube}onMouseUp(t){this.scale.set(1,1,1),this.offset&&(this.offset=!1,this.model.position.sub(this.config.selected.offset),this.wireframe.position.sub(this.config.selected.offset),this.originCube.position.sub(this.config.selected.offset)),this.wireframe.visible=!1,this.originCube.visible=!1}onRightClickDown(t){this.onMouseDown(t)}onRightClickMove(t){}onRightClickUp(t){this.onMouseUp(t)}select(t){t!==void 0&&this.wireframe.material.color.set(t),this.wireframe.visible=!0}unselect(){this.wireframe.visible=!1,this.wireframe.material.color.set(this.config.wireframe.color)}};import*as p from"three";function ht(o,t){let e=!1;if(!(o instanceof p.MeshStandardMaterial)){if(o instanceof p.Texture)o=new p.MeshStandardMaterial({map:o});else if(o instanceof p.Color)o=new p.MeshStandardMaterial({color:o});else if(typeof o=="string")if(o.includes(".")||o.includes("/")||o.includes("\\")){let i=new g;o=new p.MeshStandardMaterial({map:t.load(o,i.resolve,void 0,i.reject)}),e=i.promise}else o=new p.MeshStandardMaterial({color:new p.Color(o)})}return o.castShadow=!0,o.receiveShadow=!0,[o,e]}function at(o){let t=o.clone();return t.flipY=!0,t}function lt(o){o=o||{},typeof o=="string"&&(o={front:o});let t=o.minDimension||.01,e=o.colors||{front:"gray",back:"gray",left:"gray",right:"gray",top:"white",bottom:"gray"},i=o.dimensions||{},s=new p.TextureLoader,n=["width","height","depth"],a=[["front","back"],["left","right"],["top","bottom"]];i={width:{input:i.width,top:null,bottom:null,front:null,back:null},height:{input:i.height,front:null,back:null,left:null,right:null},depth:{input:i.depth,top:null,bottom:null,left:null,right:null}};let r=Object.assign({front:null,back:null,left:null,right:null,top:null,bottom:null},o),m=[],l=new g;for(let[h,c]of Object.entries(r))if(c){let[y,v]=ht(c,s);r[h]=y,v&&(m.push(v),v.then(C=>{["top","bottom"].includes(h)?(i.width[h]=C.image.naturalWidth,i.depth[h]=C.image.naturalHeight):["front","back"].includes(h)?(i.width[h]=C.image.naturalWidth,i.height[h]=C.image.naturalHeight):["left","right"].includes(h)&&(i.depth[h]=C.image.naturalWidth,i.height[h]=C.image.naturalHeight)}))}return Promise.all(m).then(()=>{let h={};for(let[b,w]of Object.entries(i)){let M=0,R=0;for(let[bt,nt]of Object.entries(w))bt!=="input"&&nt&&(M+=nt,R+=1);h[b]=M?M/R:0}let c=(h.width+h.height+h.depth)/3;h={width:h.width/c,height:h.height/c,depth:h.depth/c};let y=n.filter(b=>i[b].input!=null).length;if(y===0)i=h;else if(y===1){let b=n.find(M=>i[M].input!=null),w=i[b].input/h[b];i={width:h.width*w,height:h.height*w,depth:h.depth*w}}else if(y===2){let b=n.find(R=>i[R].input==null),w=h[b],M=0;for(let R of n)R!==b&&h[R]&&(M+=w*h[R]/i[R].input);M/=2,i={width:i.width.input,height:i.height.input,depth:i.depth.input},i[b]=M}else i={width:i.width.input,height:i.height.input,depth:i.depth.input};for(let[b,w]of a)r[b]&&r[w]||(r[b]?r[w]=at(r[b]):r[w]?r[b]=at(r[w]):(r[b]=new p.MeshStandardMaterial({color:e[b]}),r[w]=new p.MeshStandardMaterial({color:e[w]})));let v=[i.width,i.height,i.depth];v.sort();let C=(v[0]+v[1])/2,Y=t*C;i={width:i.width||Y,height:i.height||Y,depth:i.depth||Y};let gt=new p.BoxGeometry(i.width,i.height,i.depth),ot=new p.Mesh(gt,[r.right,r.left,r.top,r.bottom,r.front,r.back]);ot.position.set(0,i.height/2,0),l.resolve(ot)}),l.promise}function dt(o,t=.1){let e=new p.TextureLoader,i=Object.assign({top:"white",bottom:"black",side:"gray"},o),s=[],n=new g;for(let[a,r]of Object.entries(i)){let[m,l]=ht(i[a],e);i[a]=m,s.push(l)}return Promise.all(s).then(()=>{let a=o.dimensions.radius||1,r=o.dimensions.height||1,m=32,l=new p.CylinderGeometry(a,a,r,32),h=new p.Mesh(l,[i.side,i.top,i.bottom]);h.position.set(-a,r/2,-a),n.resolve(h)}),n.promise}import*as E from"three";import{OBJLoader as Rt}from"three/addons/loaders/OBJLoader.js";import"three/addons/loaders/STLLoader.js";import"three/addons/loaders/GLTFLoader.js";var V=class{constructor(t="myDatabase",e="myStore"){this.dbName=t,this.storeName=e,this.db=null;let i=new g;this.loadPromise=i.promise,this.loaded=!1;let s=indexedDB.open(this.dbName,1);s.onerror=n=>{console.error("Database error:",n.target.error),i.reject(n.target.error)},s.onupgradeneeded=n=>{this.db=n.target.result,this.db.objectStoreNames.contains(this.storeName)||this.db.createObjectStore(this.storeName)},s.onsuccess=n=>{this.db=n.target.result,this.loaded=!0,i.resolve(this.db)}}_getStore(t){return this.db.transaction([this.storeName],t).objectStore(this.storeName)}async setItem(t,e){return this.loaded||await this.loadPromise,new Promise((i,s)=>{let a=this._getStore("readwrite").put(e,t);a.onsuccess=()=>i(),a.onerror=()=>s(a.error)})}async getItem(t){return this.loaded||await this.loadPromise,new Promise((e,i)=>{let n=this._getStore("readonly").get(t);n.onsuccess=()=>e(n.result),n.onerror=()=>i(n.error)})}async deleteItem(t){return this.loaded||await this.loadPromise,new Promise((e,i)=>{let n=this._getStore("readwrite").delete(t);n.onsuccess=()=>e(),n.onerror=()=>i(n.error)})}};var D={},et=new E.ObjectLoader,it=new V;window.db=it;window.loadPaths=D;var ct=0;function mt(o){var t;let e=o.toLowerCase().split(".").pop(),i=new g;ct+=1;let s=o+"-"+ct;i.promise.then(a=>{a.name=o,console.timeEnd(s)});let n=D[o];if(n)if(n instanceof Promise)console.time(s),n.then(a=>{let r=et.parse(a);i.resolve(r)});else{console.time(s);let a=et.parse(n);return i.resolve(a),i.promise}else{let a=new g;D[o]=a.promise,it.getItem(o).then(r=>{if(r){a.resolve(r),D[o]=r;let m=et.parse(r);i.resolve(m);return}i.promise.then(m=>{r=m.toJSON(),a.resolve(r),D[o]=r,it.setItem(o,r)}),Tt(i,o,e)})}return i.promise}function Tt(o,t,e){let i;switch(e.toLowerCase()){case"gltf":i=new E.GLTFLoader,i.load(t,function(s){o.resolve(s.scene)});break;case"obj":i=new Rt,i.load(t,function(s){o.resolve(s)});break;case"stl":i=new E.STLLoader,i.load(t,function(s){let n=new E.MeshPhongMaterial({color:16733491,specular:1118481,shininess:200});var a=new E.Mesh(s,n);o.resolve(a)});break;default:o.reject("Unsupported file type:"+e);return}}import*as x from"three";var ut={gentilis_bold:"https://cdn.jsdelivr.net/gh/mrdoob/three.js/examples/fonts/gentilis_bold.typeface.json",gentilis_regular:"https://cdn.jsdelivr.net/gh/mrdoob/three.js/examples/fonts/gentilis_regular.typeface.json",helvetiker_bold:"https://cdn.jsdelivr.net/gh/mrdoob/three.js/examples/fonts/helvetiker_bold.typeface.json",helvetiker_regular:"https://cdn.jsdelivr.net/gh/mrdoob/three.js/examples/fonts/helvetiker_regular.typeface.json",optimer_bold:"https://cdn.jsdelivr.net/gh/mrdoob/three.js/examples/fonts/optimer_bold.typeface.json"};function St(o,t=1,e=0,i=.1,s="helvetiker_regular",n=12,a=!1,r={x:-Math.PI/2,y:0,z:0}){ut[s]&&(s=ut[s]);let m=new x.FontLoader,l=new g;if(!s){console.error("Font is not provided. Please load a font and pass it to the SimpleText constructor.");return}return m.load(s,function(h){let c=new x.TextGeometry(o,{font:h,size:t,height:i,curveSegments:n,bevelEnabled:a}),y=new x.MeshBasicMaterial({color:e}),v=new x.Mesh(c,y);v.rotation.set(r.x,r.y,r.z);let C=new x.Group;C.add(v),l.resolve(C)}),l.promise}function ft(o){return typeof o=="string"&&(o={text:o}),St(o.text,o.size,o.color,o.height,o.fontPath,o.curveSegments,o.bevelEnabled)}function It(o){return typeof o=="string"&&o.startsWith("{")&&o.endsWith("}")&&(o=JSON.parse(o)),o.isModelCopy?Promise.resolve(o):typeof o=="object"&&!o.text||typeof o=="string"&&o.toLowerCase().endsWith(".png")?o.dimensions&&o.dimensions.radius?dt(o):lt(o):typeof o=="string"&&o.endsWith(".json")||typeof o=="object"&&o.text?ft(o):mt(o)}var st=class extends W{constructor({src:t,color:e,name:i,position:s,rotation:n,moveable:a,metadata:r}){t instanceof Promise?super(t):super(It(t)),e!==void 0&&this.setColor(e),i&&(this.name=i),s&&this.position.set(s.x,s.y,s.z),n&&this.pivot.rotation.set(n.x,n.y,n.z),r&&(this.metadata=r),a&&(this.moveable=a)}};function pt(o,t){let e=t.substring(0,t.lastIndexOf("/")+1);return fetch(t).then(i=>i.json()).then(i=>{let s=i.metadata||{};i.metadata&&delete i.metadata;let n=i.snaps;delete i.snaps;let a=i.scene;delete i.scene,a&&o.updateConfig(a);let r={};for(let[m,l]of Object.entries(i)){l.name=m,typeof l.src=="string"?l.src=l.src.replaceAll("GAME/",e):l.src=JSON.parse(JSON.stringify(l.src).replaceAll("GAME/",e));let h=new st(l);r[m]=h,l.moveable?o.addModel(h):o.add(h)}return o.loadPromise.then(()=>{for(let[m,l]of Object.entries(i)){let h=r[m];if(l.snap){let c=n[l.snap];h.setSnapController(c.y,c.step,c.offset,c.lockedAxes,c.freeAxes,c.rotationLockedAxes,c.rotationFreeAxes,c.positionNodes,c.rotationNodes),h.snap()}else l.snap===!1&&(h.snapController=null);if(l.animation){if(l.animation.rotation){let c=l.animation.rotation;h.startRotation(c.x,c.y,c.z)}if(l.animation.position){let c=l.animation.position;h.startTranslation(c.x,c.y,c.z)}}}}),{models:r,metadata:s}})}var J=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"});let t=document.createElement("link");t.setAttribute("rel","stylesheet"),t.setAttribute("href","./src/css/style.css"),this.shadowRoot.appendChild(t);let e=document.createElement("div");e.innerHTML=`
          <select id="gameSelect" class="widget tl"></select>
          <div id="instructionsBox" class="widget tr">
                <button id="q">?</button>
                <button id = "x" class="fr hidden">x</button>
                <pre id="instructions" class="hidden">
                </pre>
          </div>
          <pre id="subtitles" class="widget bc subtitles"></pre>
          <chat-box id="chat"></chat-box>
        `,e.classList.add("fullscreen"),this.shadowRoot.appendChild(e),this.gameNames=["quoridor","chess","cube","card"];for(let i of[this.handlers,this.keydownHandlers,this.keyupHandlers])for(let[s,n]of Object.entries(i))i[s]=n.bind(this);this.onDocumentLoad=this.onDocumentLoad.bind(this),this.saveElements=this.saveElements.bind(this),this.bindElements=this.bindElements.bind(this),this.loadGame=this.loadGame.bind(this),this.showInstructions=this.showInstructions.bind(this),this.hideInstructions=this.hideInstructions.bind(this),this.rtc=new B({handlers:this.handlers}),this.voiceChat=new j(this.rtc),this.keyListeners=new S(this.keydownHandlers,this.keyupHandlers),this.keyListeners.addTo(window),this.scene=new O,this.scene.attachMQTTRTC(this.rtc),this.onDocumentLoad()}onDocumentLoad(){this.saveElements(),this.bindElements(),this.loadGame()}saveElements(){this.instructions=this.shadowRoot.getElementById("instructions"),this.q=this.shadowRoot.getElementById("q"),this.x=this.shadowRoot.getElementById("x"),this.gameSelect=this.shadowRoot.getElementById("gameSelect"),this.chat=this.shadowRoot.getElementById("chat"),this.subtitles=this.shadowRoot.getElementById("subtitles")}bindElements(){this.q.addEventListener("click",(()=>{this.showInstructions()}).bind(this)),this.x.addEventListener("click",(()=>{this.hideInstructions()}).bind(this));for(let t of this.gameNames){let e=document.createElement("option");e.value=t,e.innerHTML=t,this.gameSelect.appendChild(e)}this.gameSelect.addEventListener("change",(t=>{location.hash=t.target.value,location.reload()}).bind(this)),this.instructions.innerHTML=this.defaultInstructions,this.chat,this.chat.attachMQTTRTC(this.rtc)}loadGame(){this.gameName=location.hash.replace("#","")||localStorage.getItem("game")||"chess",localStorage.setItem("game",this.gameName),location.hash="#"+this.gameName,document.title=this.gameName,this.gameSelect.value=this.gameName;let t="../../assets/games/"+this.gameName+"/spec.min.json?"+Date.now();this.gameName,pt(this.scene,t).then((({models:e,metadata:i})=>{i.instructions&&(localStorage.getItem(game+"Instructions")===i.instructions?this.hideInstructions():this.showInstructions(),this.instructions.innerHTML=i.instructions),this.models=e}).bind(this))}handlers={sync:(t,e)=>{},dm:(t,e)=>{},chat:(t,e)=>{},moves:(t,e)=>{},audio:(t,e)=>{},subtitles:(t,e)=>{this.subtitles.style.transition="",this.subtitles.style.opacity=1,this.subtitles.innerText="["+e+"] "+t,this.subtitlesTimeout&&clearTimeout(this.subtitlesTimeout),this.subtitlesTimeout=setTimeout(()=>{this.subtitles.style.transition="opacity 3s",this.subtitles.style.opacity=0},1e3)}};defaultInstructions=`To Move:
    1. Click & drag (then it will snap to position) OR
    2. Click the use arrow keys (then it will snap)

To Rotate:
    1. Double Click OR
    2. Click and use spacebar OR
    3. Right Click and drag to rotate`;keydownHandlers={" ":()=>{this.voiceChat.startStreaming()}};keyupHandlers={" ":()=>{this.voiceChat.stopStreaming()}};hideInstructions(){document.getElementById("instructions").style.display="none",document.getElementById("q").style.display="block",document.getElementById("x").style.display="none",localStorage.setItem(game+"Instructions",window.metadata.instructions)}showInstructions(){document.getElementById("instructions").style.display="block",document.getElementById("q").style.display="none",document.getElementById("x").style.display="block",localStorage.removeItem(game+"Instructions")}};var Q=class extends HTMLElement{constructor(){super(),this.name="?",this.history=[],this.activeUsers=[],this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML=`
      <style>
        @media only screen and (max-width: 1000px){
          * {
            font-size: 12px; /* twice as big as the default size */
          }

        }
        #chat-container {
          position: fixed;
          bottom: 0.5em;
          right: 0.5em;
          border: 1px solid #ccc;
          background-color: #f9f9f9;
        }
        #chat-header {
          cursor: pointer;
          background-color: #ddd;
          padding: 10px;
          font-weight: bold;
        }
        #chat-body {
          max-height: 40vh;
          overflow: auto;
          display: none;
          padding: 10px;
        }
        #active-users {
          font-size: 0.8em;
        }
        #messages {
          margin-bottom: 10px;
        }
        #voice-button {
            float: right;
        }
        #speaker-button {
            float: right;
        }
        #clear-button {
            float: right;
        }
      </style>
      <div id="chat-container">
        <div id="chat-header">
        Chat
        <input id="chat-name" style="float:right">
        </div>

        <div id="chat-body">
          <div id="active-users"></div>

          <button id="voice-button">\u{1F399}\uFE0F</button>
          <button id="speaker-button">\u{1F50A}</button>
          <button id="clear-button">\u{1F5D1}\uFE0F</button>
          <br/>
          <div id="messages"></div>

          <input id="input-message" type="text" placeholder="Type a message...">
          <button id="send-button">Send</button>
          <button id="emoji-button" style="display: inline-block">\u{1F44B}</button>
        </div>
      </div>
    `,this.chatHeader=this.shadowRoot.getElementById("chat-header"),this.chatBody=this.shadowRoot.getElementById("chat-body"),this.chatName=this.shadowRoot.getElementById("chat-name"),this.activeUsersEl=this.shadowRoot.getElementById("active-users"),this.messagesEl=this.shadowRoot.getElementById("messages"),this.emojiButton=this.shadowRoot.getElementById("emoji-button"),this.inputMessage=this.shadowRoot.getElementById("input-message"),this.sendButton=this.shadowRoot.getElementById("send-button"),this.voiceButton=this.shadowRoot.getElementById("voice-button"),this.clearButton=this.shadowRoot.getElementById("clear-button"),this.speakerButton=this.shadowRoot.getElementById("speaker-button"),this.clearButton.addEventListener("click",()=>{this.messagesEl.innerHTML=""}),this.streaming=!1,this.voiceButton.addEventListener("click",(()=>{this.streaming?(this.voiceButton.style.backgroundColor="",this.streaming=!1,this.rtc.stopStreaming()):(this.voiceButton.style.backgroundColor="red",this.streaming=!0,this.rtc.startStreaming())}).bind(this)),this.muted=!0,this.speakerButton.addEventListener("click",(()=>{this.muted?(this.muted=!1,this.rtc.unmute(),this.speakerButton.style.backgroundColor="red"):(this.muted=!0,this.rtc.mute(),this.speakerButton.style.backgroundColor="")}).bind(this)),this.pingTime=0,this.emojiButton.addEventListener("click",this.ping.bind(this)),this.chatName.value=localStorage.getItem("name")||"?",this.chatName.addEventListener("change",(()=>{""+this.chatName.value,localStorage.setItem("name",this.chatName.value),this.rtc?(this.rtc.name=this.chatName.value,this.rtc.tabID&&!this.rtc.name.endsWith(this.rtc.tabID)&&(this.rtc.name+="_"+this.rtc.tabID),this.name=this.rtc.name,this.chatName.value=this.name):this.name=this.chatName.value}).bind(this)),this.sendMessage=this.sendMessage.bind(this),this.attachMQTTRTC=this.attachMQTTRTC.bind(this),this.inputMessage.addEventListener("keydown",t=>{t.key==="Enter"&&!t.ctrlKey&&this.sendMessage(),t.stopPropagation()}),this.chatHeader.addEventListener("click",()=>this.toggleChat()),this.sendButton.addEventListener("click",()=>this.sendMessage()),this.history.forEach(t=>this.appendMessage(t)),this.chatBody.style.display="block"}attachMQTTRTC(t){this.rtc=t,this.send=t.sendChat.bind(t),this.name=t.name,this.chatName.value=this.name,t.handlers.chat=(e,i)=>{this.receive.bind(this)({data:e,sender:i,timestamp:Date.now()})},t.handlers.activeUsers=e=>{this.onActiveUsersChange.bind(this)(e)}}setHistory(t){this.history=t,this.history.forEach(e=>this.appendMessage(e))}send(t){console.warn("No MQTT connection")}ping(){this.sendMessage("\u{1F44B}"),this.pingTime=Date.now()}receive({data:t,sender:e,timestamp:i}){t==="\u{1F44B}"&&Date.now()-this.pingTime>2e3&&this.ping(),this.history.push({data:t,sender:e,timestamp:i}),this.appendMessage({data:t,sender:e,timestamp:i})}toggleChat(){this.chatBody.style.display=this.chatBody.style.display==="none"?"block":"none"}sendMessage(t){t=t||this.inputMessage.value,this.send(t),this.appendMessage({data:t,sender:this.name+"( You )",timestamp:new Date}),this.inputMessage.value=""}appendMessage({data:t,sender:e,timestamp:i}){let s=document.createElement("div");s.textContent=`${e}: ${t}`,this.messagesEl.appendChild(s)}onActiveUsersChange(t){this.activeUsers=t,this.activeUsersEl.innerHTML="Active users: "+t.join(", ")}};customElements.define("chat-box",Q);customElements.define("game-board",J);
