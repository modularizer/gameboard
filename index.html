<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chess</title>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script>
          const importMap = {
            imports: {
              "three": "https://unpkg.com/three@0.132.2/build/three.module.js",
              "three/addons/": "https://unpkg.com/three@0.132.2/examples/jsm/",
              "three/loaders": "https://unpkg.com/three@0.132.2/examples/jsm/loaders/",
              "utils": `./js/utils/index.js?${Date.now()}`,
              "gameengine": `./js/index.js?${Date.now()}`,
            }
          };

          const script = document.createElement('script');
          script.type = 'importmap';
          script.innerHTML = JSON.stringify(importMap);

          document.head.append(script);
    </script>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: sans-serif;
            height: 100vh;
            width: 100vw;
        }
        @media only screen and (max-width: 1000px){
          * {
            font-size: 10px; /* twice as big as the default size */
          }
        }
    </style>
</head>
<body>
    <select id="game" style="position: absolute; z-index:9999;left: 0.5em; top: 0.5em;">
    <option>chess</option>
    <option>quoridor</option>
    <option>card</option>
    <option>cube</option>
</select>
    <div style="position: absolute; border-radius: 5px; right: 0.5em; top: 0.5em; z-index:9999; background-color: #fff; padding: 5px;">
        <button id="q" style="float:right; border-radius: 5px; display: block" onclick="showInstructions()">?</button>
        <button id = "x" style="display: none;float:right; border-radius: 5px;" onclick="hideInstructions()">x</button>
        <div id="instructions"  style="display: none">
            <pre/>To Move:
    1. Click & drag (then it will snap to position) OR
    2. Click the use arrow keys (then it will snap)

To Rotate:
    1. Double Click OR
    2. Click and use spacebar OR
    3. Right Click and drag to rotate </pre>
        </div>
    </div>

    <div style="position: absolute; bottom: 0.5em; width: 100%; display: flex; justify-content: center; align-items: center;">
        <pre id="subtitles" style="opacity: 0; background-color: #000; color: #fff; text-align: center; padding: 10px;">
        </pre>
    </div>
    <my-chat></my-chat>

    <script type="module">
        import * as THREE from 'three';
        window.THREE = THREE;
        import * as gameengine from 'gameengine';
        import { CustomScene, loadJSON } from 'gameengine';
        import { MQTTRTCClient, WebRTCAudioChannel } from 'utils';


        window.rtc = new MQTTRTCClient({handlers:{
            sync: (data, sender) => {console.log("Received sync from", sender, data);},
            dm: (data, sender) => {console.log("Received DM from", sender, data);},
            chat: (data, sender) => {console.log("Received group chat from", sender, data);},
            moves: (data, sender) => {console.log("Received moves from", sender, data);},
            audio: (data, sender) => {console.log("Received audio from", sender, data);},
            subtitles: (data, sender) => {
                document.getElementById("subtitles").style.transition = "";
                document.getElementById("subtitles").style.opacity = 1;
                document.getElementById("subtitles").innerText = "[" + sender + "] " + data;
                if (window.subtitlesTimeout) {clearTimeout(window.subtitlesTimeout)};
                window.subtitlesTimeout = setTimeout(() => {
                    document.getElementById("subtitles").style.transition = "opacity 3s";
                    document.getElementById("subtitles").style.opacity = 0;
                }, 1000);
            },
        }});

        window.voiceChat = new WebRTCAudioChannel(rtc);
        window.vc = voiceChat;

        window.addEventListener("keydown", (e) => {
            if (e.key === " ") {
                voiceChat.startStreaming();
            }
        });
        window.addEventListener("keyup", (e) => {
            if (e.key === " ") {
                voiceChat.stopStreaming();
            }
        });


        window.gameengine = gameengine;
        window.scene = new CustomScene();

        window.hideInstructions = () => {
            document.getElementById("instructions").style.display = "none";
            document.getElementById("q").style.display = "block";
            document.getElementById("x").style.display = "none";
            localStorage.setItem(game + "Instructions", window.metadata.instructions);
        }
        window.showInstructions = () => {
            document.getElementById("instructions").style.display = "block";
            document.getElementById("q").style.display = "none";
            document.getElementById("x").style.display = "block";
            localStorage.removeItem(game + "Instructions");
        }

        let gameSelect = document.getElementById("game");
        gameSelect.addEventListener("change", (e) => {
            location.hash = e.target.value;
            location.reload();
        });
        window.game = location.hash.replace("#", "") || localStorage.getItem("game") || "chess";
        localStorage.setItem("game", window.game);
        location.hash = "#" + window.game;
        document.title = window.game;
        gameSelect.value = window.game;


        console.log("game", "./games/" + window.game + "/spec.json?" + Date.now());
        loadJSON(scene, "./games/" + window.game + "/spec.json?" + Date.now()).then(({models, metadata}) => {
            window.metadata = metadata;
            if (metadata.instructions) {
                let i = localStorage.getItem(game + "Instructions");
                if (i === metadata.instructions) {
                    hideInstructions();
                }else {
                    showInstructions();
                }

                document.getElementById("instructions").innerHTML = metadata.instructions;
            }
            window.models = models;
        });
        chat.attachMQTTRTC(rtc);
        scene.attachMQTTRTC(rtc);


    </script>


</body>
</html>