<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chess</title>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script>
          const importMap = {
            imports: {
              "three": "https://unpkg.com/three@0.132.2/build/three.module.js",
              "three/addons/": "https://unpkg.com/three@0.132.2/examples/jsm/",
              "three/loaders": "https://unpkg.com/three@0.132.2/examples/jsm/loaders/",
              "utils": `./js/utils/index.js?${Date.now()}`,
              "gameengine": `./js/index.js?${Date.now()}`,
            }
          };

          const script = document.createElement('script');
          script.type = 'importmap';
          script.innerHTML = JSON.stringify(importMap);

          document.head.append(script);
    </script>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        @media only screen and (max-width: 768px) {
          body {
            font-size: 32px; /* twice as big as the default size */
          }
        }
    </style>


</head>
<body style="width:100%;height:100%;overflow:hidden;">
    <select id="game" style="position: absolute; z-index:9999;font-size:1.5em;">
        <option>chess</option>
        <option>quoridor</option>
        <option>card</option>
        <option>cube</option>
    </select>
    <div style="font-size: 1.5em;position: absolute; border-radius: 5px; right: 1em; top: 1em; z-index:9999; background-color: #fff; padding: 5px;">
        <button id="q" style="float:right; border-radius: 5px; display: block" onclick="showInstructions()">?</button>
        <button id = "x" style="display: none;float:right; border-radius: 5px;" onclick="hideInstructions()">x</button>
        <div id="instructions"  style="display: none">
            <pre/>To Move:
    1. Click & drag (then it will snap to position) OR
    2. Click the use arrow keys (then it will snap)

To Rotate:
    1. Double Click OR
    2. Click and use spacebar OR
    3. Right Click and drag to rotate </pre>
        </div>
    </div>
    <my-chat></my-chat>
    <script type="module">
        import * as THREE from 'three';
        window.THREE = THREE;
        import * as gameengine from 'gameengine';
        import { CustomScene, loadJSON } from 'gameengine';
        import { MQTTRTCClient } from 'utils';

        window.rtc = new MQTTRTCClient();

        window.gameengine = gameengine;
        window.scene = new CustomScene();

        window.hideInstructions = () => {
            document.getElementById("instructions").style.display = "none";
            document.getElementById("q").style.display = "block";
            document.getElementById("x").style.display = "none";
            localStorage.setItem(game + "Instructions", window.metadata.instructions);
        }
        window.showInstructions = () => {
            document.getElementById("instructions").style.display = "block";
            document.getElementById("q").style.display = "none";
            document.getElementById("x").style.display = "block";
            localStorage.removeItem(game + "Instructions");
        }

        let gameSelect = document.getElementById("game");
        gameSelect.addEventListener("change", (e) => {
            location.hash = e.target.value;
            location.reload();
        });
        window.game = location.hash.replace("#", "") || localStorage.getItem("game") || "chess";
        localStorage.setItem("game", window.game);
        location.hash = "#" + window.game;
        document.title = window.game;
        gameSelect.value = window.game;


        console.log("game", "./games/" + window.game + "/spec.json?" + Date.now());
        loadJSON(scene, "./games/" + window.game + "/spec.json?" + Date.now()).then(({models, metadata}) => {
            window.metadata = metadata;
            if (metadata.instructions) {
                let i = localStorage.getItem(game + "Instructions");
                if (i === metadata.instructions) {
                    hideInstructions();
                }else {
                    showInstructions();
                }

                document.getElementById("instructions").innerHTML = metadata.instructions;
            }
            window.models = models;
        });
        chat.attachMQTTRTC(rtc);
        scene.attachMQTTRTC(rtc);


    </script>
</body>
</html>